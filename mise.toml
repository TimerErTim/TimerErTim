[settings]
experimental = true
lockfile = true

[env]
"_".file = "{{ config_root }}/.env.local"
TYPST_FONT_PATHS = "{{ config_root }}/fonts"

[tools]
"rust" = "nightly"
"node" = "latest"

[tasks.build]
description = "Build README.typ and write to dist/"
run = [
  "mkdir -p dist/",
  "processing/compile-typst/target/release/compile-typst README.typ dist/",
]

[tasks.rebuild]
description = "Rebuild the README.typ with all dependencies"
usage = """
arg "<github-username>" env="GITHUB_USERNAME" help="GitHub username for snake contribution graph"
arg "<github-token>" env="GITHUB_TOKEN" help="GitHub token for snake contribution graph"
"""
run = [
  'GITHUB_TOKEN="$usage_github_token" GITHUB_USERNAME="$usage_github_username" mise run generate-snake ::: generate-typing-banner ::: generate-spotify-playing ::: generate-tech-stack',
  "mise run compile:builder",
  "mise run build",
]

[tasks."compile:builder"]
description = "Compile the compile-typst crate"
dir = "{{ config_root }}/processing/compile-typst"
sources = ["src/**/*.rs", "Cargo.toml", "Cargo.lock"]
outputs = ["compile-typst"]
run = ["cargo build --release"]


[tasks."generate-snake"]
description = "Generate snake contribution graph"
usage = """
arg "<username>" env="GITHUB_USERNAME" help="Username for pacman contribution graph"
arg "<github-token>" env="GITHUB_TOKEN" help="GitHub token for snake contribution graph"
"""
run = """
#!/usr/bin/env bash
set -euo pipefail
mkdir -p out
INPUT_OUTPUTS="
  out/snake-contribution-graph-light.svg?color_snake=orange
  out/snake-contribution-graph-dark.svg?palette=github-dark&color_snake=blue
" \
INPUT_GITHUB_USER_NAME="$usage_username" \
INPUT_GITHUB_TOKEN="$usage_github_token" \
node processing/snk/index.js
"""

[tasks."generate-typing-banner"]
description = "Generate typing banner"
run = """
#!/usr/bin/env bash
export LINES="Hi+there+ðŸ‘‹,+I'm+TimerErTim!;Welcome+on+my+profile!;It's+compiled+with+Typst;https://github.com/TimerErTim"
mise run download-url "https://readme-typing-svg.herokuapp.com?font=Fira+Code&weight=600&size=28&duration=2000&pause=1000&color=d66730&center=true&vCenter=true&width=600&lines=${LINES}" out/typing-banner-light.svg
mise run download-url "https://readme-typing-svg.herokuapp.com?font=Fira+Code&weight=600&size=28&duration=2000&pause=1000&color=edb76f&center=true&vCenter=true&width=600&lines=${LINES}" out/typing-banner-dark.svg
"""

[tasks."generate-spotify-playing"]
description = "Generate spotify playing"
run = { tasks = [
  "download-url http://server.timerertim.eu:5000 out/spotify-playing.svg",
] }

[tasks."generate-github-stats"]
description = "Generate github stats"
run = [
  { tasks = [
    "download-url https://github-readme-stats.vercel.app/api?username=TimerErTim&show_icons=true&theme=default&hide_border=true&bg_color=000000&title_color=fabd2f out/github-stats-light.svg",
    "download-url https://github-readme-stats.vercel.app/api?username=TimerErTim&show_icons=true&theme=dark&hide_border=true&bg_color=00000000 out/github-stats-dark.svg",
  ] },
]

[tasks."generate-tech-stack"]
description = "Generate tech stack SVGs"
run = [
  { tasks = [
    "download-url https://github-readme-tech-stack.vercel.app/api/cards?title=o&showBorder=false&lineCount=3&theme=github&hideBg=true&hideTitle=true&line1=rust%2CRust%2CB7410E%3Bnext.js%2CNext.JS%2C000000%3Btailwindcss%2CTailwindCSS%2C06B6D4%3Bsqlite%2CSQLite%2C003B57%3B&line2=fishshell%2CFish%2C34C534%3Bdata%3Aimage%2Fsvg%2Bxml%3Bbase64%2CPHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjEyMCIgdmlld0JveD0iMTUgMjUgOTAgNzAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI%2BCiAgPGRlZnM%2BCiAgICA8bGluZWFyR3JhZGllbnQgaWQ9ImJvcmRlckdyYWRpZW50IiB4MT0iMCUiIHkxPSIwJSIgeDI9IjEwMCUiIHkyPSIxMDAlIj4KICAgICAgPHN0b3Agb2Zmc2V0PSIwJSIgc3R5bGU9InN0b3AtY29sb3I6IzAwZDlmZjtzdG9wLW9wYWNpdHk6MSIgLz4KICAgICAgPHN0b3Agb2Zmc2V0PSI1MCUiIHN0eWxlPSJzdG9wLWNvbG9yOiM1MmU4OTI7c3RvcC1vcGFjaXR5OjEiIC8%2BCiAgICAgIDxzdG9wIG9mZnNldD0iMTAwJSIgc3R5bGU9InN0b3AtY29sb3I6I2ZmOTEwMDtzdG9wLW9wYWNpdHk6MSIgLz4KICAgIDwvbGluZWFyR3JhZGllbnQ%2BCiAgPC9kZWZzPgoKICA8IS0tIE1haW4gdGVybWluYWwgd2luZG93IC0tPgogIDxyZWN0IHg9IjIwIiB5PSIzMCIgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiByeD0iOCIKICAgICAgICBmaWxsPSIjMWExYTFhIgogICAgICAgIHN0cm9rZT0idXJsKCNib3JkZXJHcmFkaWVudCkiCiAgICAgICAgc3Ryb2tlLXdpZHRoPSIzIi8%2BCgogIDwhLS0gVGVybWluYWwgaGVhZGVyIGJhciAtIHNvbGlkIGRhcmsgY29sb3IgKGFkanVzdGVkIHRvIGZpdCB3aXRoaW4gc3Ryb2tlKSAtLT4KICA8cmVjdCB4PSIyMS41IiB5PSIzMS41IiB3aWR0aD0iNzciIGhlaWdodD0iMTYiIHJ4PSI2IgogICAgICAgIGZpbGw9IiMyYTJhMmEiLz4KCiAgPCEtLSBUZXJtaW5hbCB3aW5kb3cgY29udHJvbHMgLS0%2BCiAgPGNpcmNsZSBjeD0iMzIiIGN5PSIzOSIgcj0iMyIgZmlsbD0iI2ZmNTI1MiIvPgogIDxjaXJjbGUgY3g9IjQ0IiBjeT0iMzkiIHI9IjMiIGZpbGw9IiNmZmJkMmUiLz4KICA8Y2lyY2xlIGN4PSI1NiIgY3k9IjM5IiByPSIzIiBmaWxsPSIjNTJlODkyIi8%2BCgogIDwhLS0gQ29tbWFuZCBwcm9tcHQgc3ltYm9sIChtb3ZlZCB1cCBzbGlnaHRseSkgLS0%2BCiAgPHRleHQgeD0iMjgiIHk9IjY0IgogICAgICAgIGZvbnQtZmFtaWx5PSJtb25vc3BhY2UiCiAgICAgICAgZm9udC1zaXplPSIxNiIKICAgICAgICBmb250LXdlaWdodD0iYm9sZCIKICAgICAgICBmaWxsPSIjNTJlODkyIj4KICAgICZndDtfCiAgPC90ZXh0PgoKICA8IS0tIENvbW1hbmQgbGluZXMgLSBhZGp1c3RlZCBzcGFjaW5nIC0tPgogIDxyZWN0IHg9IjUyIiB5PSI1NiIgd2lkdGg9IjM1IiBoZWlnaHQ9IjIuNSIgZmlsbD0iIzAwZDlmZiIgb3BhY2l0eT0iMC43Ii8%2BCiAgPHJlY3QgeD0iMjgiIHk9Ijc0IiB3aWR0aD0iMjUiIGhlaWdodD0iMi41IiBmaWxsPSIjNTJlODkyIiBvcGFjaXR5PSIwLjYiLz4KICA8cmVjdCB4PSI1NiIgeT0iNzQiIHdpZHRoPSIxOCIgaGVpZ2h0PSIyLjUiIGZpbGw9IiNmZjkxMDAiIG9wYWNpdHk9IjAuNiIvPgogIDxyZWN0IHg9IjI4IiB5PSI4MiIgd2lkdGg9IjM4IiBoZWlnaHQ9IjIuNSIgZmlsbD0iIzAwZDlmZiIgb3BhY2l0eT0iMC40Ii8%2BCjwvc3ZnPg%3D%3D%2Cmise%2C%3Bstarship%2CStarship%2CDD0B78%3BHelix%2CHelix%2C281733%3B&line3=typst%2CTypst%2C239DAD%3Bobsidian%2CObsidian%2C7C3AED%3Bcursor%2CCursor%2C000000%3B out/tech-stack-light.svg",
    "download-url https://github-readme-tech-stack.vercel.app/api/cards?title=o&showBorder=false&lineCount=3&theme=github_dark&hideBg=true&hideTitle=true&line1=rust%2CRust%2CB7410E%3Bnext.js%2CNext.JS%2Cffffff%3Btailwindcss%2CTailwindCSS%2C06B6D4%3Bsqlite%2CSQLite%2C003B57%3B&line2=fishshell%2CFish%2C34C534%3Bdata%3Aimage%2Fsvg%2Bxml%3Bbase64%2CPHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjEyMCIgdmlld0JveD0iMTUgMjUgOTAgNzAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI%2BCiAgPGRlZnM%2BCiAgICA8bGluZWFyR3JhZGllbnQgaWQ9ImJvcmRlckdyYWRpZW50IiB4MT0iMCUiIHkxPSIwJSIgeDI9IjEwMCUiIHkyPSIxMDAlIj4KICAgICAgPHN0b3Agb2Zmc2V0PSIwJSIgc3R5bGU9InN0b3AtY29sb3I6IzAwZDlmZjtzdG9wLW9wYWNpdHk6MSIgLz4KICAgICAgPHN0b3Agb2Zmc2V0PSI1MCUiIHN0eWxlPSJzdG9wLWNvbG9yOiM1MmU4OTI7c3RvcC1vcGFjaXR5OjEiIC8%2BCiAgICAgIDxzdG9wIG9mZnNldD0iMTAwJSIgc3R5bGU9InN0b3AtY29sb3I6I2ZmOTEwMDtzdG9wLW9wYWNpdHk6MSIgLz4KICAgIDwvbGluZWFyR3JhZGllbnQ%2BCiAgPC9kZWZzPgoKICA8IS0tIE1haW4gdGVybWluYWwgd2luZG93IC0tPgogIDxyZWN0IHg9IjIwIiB5PSIzMCIgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiByeD0iOCIKICAgICAgICBmaWxsPSIjMWExYTFhIgogICAgICAgIHN0cm9rZT0idXJsKCNib3JkZXJHcmFkaWVudCkiCiAgICAgICAgc3Ryb2tlLXdpZHRoPSIzIi8%2BCgogIDwhLS0gVGVybWluYWwgaGVhZGVyIGJhciAtIHNvbGlkIGRhcmsgY29sb3IgKGFkanVzdGVkIHRvIGZpdCB3aXRoaW4gc3Ryb2tlKSAtLT4KICA8cmVjdCB4PSIyMS41IiB5PSIzMS41IiB3aWR0aD0iNzciIGhlaWdodD0iMTYiIHJ4PSI2IgogICAgICAgIGZpbGw9IiMyYTJhMmEiLz4KCiAgPCEtLSBUZXJtaW5hbCB3aW5kb3cgY29udHJvbHMgLS0%2BCiAgPGNpcmNsZSBjeD0iMzIiIGN5PSIzOSIgcj0iMyIgZmlsbD0iI2ZmNTI1MiIvPgogIDxjaXJjbGUgY3g9IjQ0IiBjeT0iMzkiIHI9IjMiIGZpbGw9IiNmZmJkMmUiLz4KICA8Y2lyY2xlIGN4PSI1NiIgY3k9IjM5IiByPSIzIiBmaWxsPSIjNTJlODkyIi8%2BCgogIDwhLS0gQ29tbWFuZCBwcm9tcHQgc3ltYm9sIChtb3ZlZCB1cCBzbGlnaHRseSkgLS0%2BCiAgPHRleHQgeD0iMjgiIHk9IjY0IgogICAgICAgIGZvbnQtZmFtaWx5PSJtb25vc3BhY2UiCiAgICAgICAgZm9udC1zaXplPSIxNiIKICAgICAgICBmb250LXdlaWdodD0iYm9sZCIKICAgICAgICBmaWxsPSIjNTJlODkyIj4KICAgICZndDtfCiAgPC90ZXh0PgoKICA8IS0tIENvbW1hbmQgbGluZXMgLSBhZGp1c3RlZCBzcGFjaW5nIC0tPgogIDxyZWN0IHg9IjUyIiB5PSI1NiIgd2lkdGg9IjM1IiBoZWlnaHQ9IjIuNSIgZmlsbD0iIzAwZDlmZiIgb3BhY2l0eT0iMC43Ii8%2BCiAgPHJlY3QgeD0iMjgiIHk9Ijc0IiB3aWR0aD0iMjUiIGhlaWdodD0iMi41IiBmaWxsPSIjNTJlODkyIiBvcGFjaXR5PSIwLjYiLz4KICA8cmVjdCB4PSI1NiIgeT0iNzQiIHdpZHRoPSIxOCIgaGVpZ2h0PSIyLjUiIGZpbGw9IiNmZjkxMDAiIG9wYWNpdHk9IjAuNiIvPgogIDxyZWN0IHg9IjI4IiB5PSI4MiIgd2lkdGg9IjM4IiBoZWlnaHQ9IjIuNSIgZmlsbD0iIzAwZDlmZiIgb3BhY2l0eT0iMC40Ii8%2BCjwvc3ZnPg%3D%3D%2Cmise%2C%3Bstarship%2CStarship%2CDD0B78%3BHelix%2CHelix%2Cb700ff%3B&line3=typst%2CTypst%2C239DAD%3Bobsidian%2CObsidian%2C7C3AED%3Bcursor%2CCursor%2Cffffff%3B out/tech-stack-dark.svg",
  ] },
]

[tasks."download-url"]
description = "Download URL"
usage = """
arg "<url>" help="URL to download"
arg "<file>" help="Filename to save to"
"""
run = """
#!/usr/bin/env node
const fs = require('fs');
const path = require('path');

const urlStr = process.env.usage_url.trim();
const filename = process.env.usage_file.trim();

try {
  const url = new URL(urlStr);
  const protocol = url.protocol === 'https:' ? require('https') : require('http');

  protocol.get(urlStr, (response) => {
    const { statusCode } = response;

    if (statusCode !== 200) {
      console.error(`Warning: Download failed... Status ${statusCode}`);
      response.resume(); 
      process.exit(0);
    }

    // Ensure parent directory exists only after confirming 200 OK
    const dir = path.dirname(filename);
    if (!fs.existsSync(dir)) {
      fs.mkdirSync(dir, { recursive: true });
    }

    const file = fs.createWriteStream(filename);
    response.pipe(file);

    file.on('finish', () => {
      file.close();
      console.log(`Successfully saved: ${filename}`);
    });

    file.on('error', (err) => {
      console.error(`FS Error: ${err.message}`);
      // Clean up partial file if write fails
      if (fs.existsSync(filename)) fs.unlinkSync(filename);
    });

  }).on('error', (err) => {
    console.error(`Warning: Network Error... ${err.message}`);
    process.exit(0);
  });

} catch (err) {
  console.error(`Error: ${err.message}\n`, `URL: ${urlStr}\n`, `Filename: ${filename}`);
  process.exit(1);
}
"""
